#version 330 core

uniform sampler2D textureUnit0;
uniform sampler2D textureUnit1;
uniform sampler2D textureUnit2;

uniform sampler2DShadow depthTexture;

uniform mat4 shadowMatrix;

uniform vec3 lightPosition;
uniform vec3 lightColor;

uniform sampler2D textureColor;
uniform sampler2D texturePosition;
uniform sampler2D textureNormal;


in vec2 vOutTexCoord0;

void main()
{
	vec4 color = texture2D(textureUnit0, vOutTexCoord0);	
	vec4 position = texture2D(textureUnit1, vOutTexCoord0);	
	vec4 normal = texture2D(textureUnit2, vOutTexCoord0);	
	
	float f = textureProj(depthTexture, shadowMatrix * position);
	vec3 mainLightDir = normalize(lightPosition - position.xyz);
	float mainRate = max(dot(mainLightDir, normal.xyz), 0);
	vec3 lightCTotal =  mainRate * lightColor;
	
	vec4 positionOfVal = shadowMatrix * position;
	vec2 texPos = positionOfVal.xy / positionOfVal.w;

	float width = 16;
	float height = 16;
	float scale = 16;
	
	float xoffset = 0.5 * scale / width;
	float yoffset = 0.5 * scale / height;

	vec3 indirectLC = vec3(0.0, 0.0, 0.0);
	for (int i=0; i<scale; i+=1)
	{
		for (int j=0; j<scale; j+=1)
		{
			float x = min(max(i / width + texPos.x - xoffset, 0.0), 1.0);
			float y = min(max(j / height + texPos.y - yoffset, 0.0), 1.0);
			vec2 tex = vec2(x, y);//vec2(i * 1.0 / width, j * 1.0 / height);
			vec4 lightC = texture2D(textureColor, tex);
			vec4 lightP = texture2D(texturePosition, tex);
			vec4 lightN = texture2D(textureNormal, tex);
			float lightRate = max(dot(mainLightDir, lightN.xyz), 0);
			
			vec3 dir = normalize(lightP.xyz - position.xyz);
			
			vec3 shootColor = max(dot(-dir, lightN.xyz), 0) * lightC.rgb;
			vec3 irradiance = shootColor * max(dot(normal.xyz, (lightP - position).xyz), 0) / pow(distance(lightP.xyz, position.xyz), 3.0);
			indirectLC += irradiance;
			
			float rate = max((dot(dir, normal.xyz)), 0.0) * (max(sign(dot(-dir, lightN.xyz)), 0.0));
			//indirectLC += (rate * lightC.xyz * lightRate) / pow(distance(position.xyz, lightP.xyz), 3.0);
		}
	}
	
	lightCTotal += indirectLC;

	//gl_FragColor = mix(vec4(lightCTotal.xyz, 1.0) * color, vec4(indirectLC, 1.0), 0.5);
	//gl_FragColor = vec4(indirectLC * color.xyz, 1.0);
	gl_FragColor = vec4(lightCTotal * color.xyz, 1.0);
}